<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>支付宝口令红包 - 码商管理后台</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {if condition="$Think.cookie.yhk_order_refresh eq 1"}
  <meta http-equiv="refresh" content="30">
  {/if}
  {include file="/common/link"}

  <style>
    .layui-card-body fieldset {
      margin: 0;
      border: 1px solid #e6e6e6;
      padding: 10px 20px 5px 20px;
      color: #6b6b6b;
    }

    .layui-card .layui-table-view {

      margin-top: 10px;
    }

    .layui-table-cell {
      height: auto;
      overflow: visible;
      text-overflow: inherit;
      white-space: normal;
      word-break: break-all;
    }  </style>
</head>
<body layadmin-themealias="default">

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">

      {include file="/common/order_header"}

      <fieldset id="searchFieldset_currentTableRenderId" class="table-search-fieldset layui-hide1">
        <legend>高级搜索</legend>
        <form class="layui-form layui-form-pane form-search">
          <div class="layui-form-item layui-inline">
            <label class="layui-form-label">订单口令</label>
            <div class="layui-input-inline">
              <input id="c-order_id" name="id" data-search-op="=" value=""
                     placeholder="请输入订单口令" class="layui-input">
            </div>
          </div>
          <div class="layui-form-item layui-inline">
            <label class="layui-form-label">订单号</label>
            <div class="layui-input-inline">
              <input id="c-order_no" name="order_no" data-search-op="=" value=""
                     placeholder="请输入订单号" class="layui-input">
            </div>
          </div>
          <div class="layui-form-item layui-inline">
            <label class="layui-form-label">开始时间</label>
            <div class="layui-input-block">
              <input type="text" name="start_time" class="layui-input app-laydate-item" placeholder="yyyy-MM-dd HH:mm:ss">
            </div>
          </div>
          <div class="layui-form-item layui-inline">
            <label class="layui-form-label">结束时间</label>
            <div class="layui-input-block">
              <input type="text" name="end_time" class="layui-input app-laydate-item" placeholder="yyyy-MM-dd HH:mm:ss">
            </div>
          </div>
          <div class="layui-form-item layui-inline">
            <label class="layui-form-label">订单状态</label>
            <div class="layui-input-inline">
              <select class="layui-select" id="c-status" name="status"
                      data-search-op="=">
                <option value="-1">- 全部 -</option>
                <option value="0">待支付</option>
                <option value="1">已支付</option>
                <option value="2">已关闭</option>
                <option value="3">已过期</option>
              </select>

            </div>
          </div>

          <div class="layui-form-item layui-inline" style="margin-left: 115px">
            <button type="submit" class="layui-btn layui-btn-normal" data-type="tableSearch"
                    data-table="currentTableRenderId" lay-submit
                    lay-filter="order-search"> 搜 索
            </button>
            <button type="reset" class="layui-btn layui-btn-primary"
                    data-table-reset="currentTableRenderId"> 重 置
            </button>
          </div>
        </form>
      </fieldset>
      <blockquote class="layui-elem-quote layui-text">

        当前订单总金额：<span id="amount" class="layui-badge layui-bg-black">{$fees.amount}</span> 元
        成交总金额：<span id="success_amount" class="layui-badge layui-bg-green">{$fees.success_amount}</span> 元
        当前订单总数：<span id="count" class="layui-badge layui-bg-black">{$fees.count}</span> 单
        成交订单总数：<span id="success_count" class="layui-badge layui-bg-green">{$fees.success_count}</span> 单
        成功率：<span id="success_rate" class="layui-badge layui-bg-blue">{$fees.success_rate}</span> % &nbsp;
      </blockquote>

      <table class="layui-hide" id="payOrderList" lay-filter="payOrderListFilter"></table>
    </div>
  </div>
</div>

<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm layui-bg-cyan" lay-event="refresh">刷新订单</button>
    <button class="layui-btn layui-btn-sm" lay-event="export">导出</button>
    <input type="checkbox" lay-skin="switch" lay-filter="auto-refresh"  lay-text="自动刷新开|自动刷新关"
           {if condition="$Think.cookie.yhk_order_refresh eq 1"}checked{/if} >
  </div>
</script>

<script type="text/html" id="table-order">
  {{#  if(d.status != 1 && d.status!=2 && d.status!=3 && d.legality==1) { }}
<!--  <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="issueOrder">确认收款</a>-->
<!--  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="is_legality">标记异常</a>-->
  {{#  if(d.cardKey == '') { }}
  <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="uploadCardKey">上传卡密</a>
  {{# } }}
  {{# } }}
  {if condition="$agent_id eq 26"}
  {{#  if(d.status == 2) { }}
<!--  <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="issueOrders">确认收款</a>-->
  {{# } }}
  {/if}
</script>



<script type="text/html" id="table-select-card">
  {{#  if(d.cardKey != '') { }}
  <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="select-card">查看</a>
  {{# } }}
</script>

</body>
</html>
{include file="common/js"}

<script type="text/javascript" src="__MS__/js/clipboard.min.js"></script>

<script>

  layui.use(['table', 'form', 'laydate'], function () {
    var $ = layui.jquery,
            form = layui.form,
            laydate = layui.laydate,
            util = layui.util,
            table = layui.table,
            layer = layui.layer,
            upload = layui.upload;


    window.copy_txt = function (id) {
      var clipboard = new ClipboardJS('.' + id);
      clipboard.on('success', function (e) {
        layer.msg("复制成功", {icon: 1, time: 1500})
        e.clearSelection();
      });
      clipboard.on('error', function (e) {
        layer.msg("复制失败，请手动复制", 1500)
      });
    }


    table.render({
      elem: '#payOrderList'
      , url: "/member/pay/lists?pay_code={:input('pay_code')}&code_id={:input('code_id')}"
      , defaultToolbar: []
      , toolbar: '#toolbarDemo'
      , page: true
      , response: {statusCode: 1}
      , cols: [[
        {field: 'id',align:"center" , title: '订单口令', templet: function (d) {
            var id = d.id;
            var a = 20000000;
            var res = a+id;
            return res;
          }}
        ,{field: 'account_number',width: 150,align:"center" , title: '核销账号',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.account_number + '</span>';
            }else{
              return d.account_number;
            }
          }
        }
        , {field: 'cardKey',width: 240,align:"center" , title: '卡密',
          templet: function (d) {
            var roles = '';
            if (d.cardKey != '') {
              roles = d.cardKey + '&nbsp;&nbsp;&nbsp;' +
                      '<a class="layui-btn layui-btn-normal layui-btn-xs copy3" href="javascript:void(0);" data-clipboard-text="' + d.cardKey + '" ' +
                      'onclick="copy_txt(\'copy3\')">\n' +
                      '复制' +
                      '</a>'
            } else {
              roles = ''
            }
            return roles;
          }
        }
        ,{field: 'order_no', width: 200, align:"center" ,title: '订单号',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.order_no + '</span>';
            }else{
              return d.order_no;
            }
          }}
        , {field: 'order_price', width: 120,align:"center" , title: '订单金额',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.order_price + '</span>';
            }else{
              return d.order_price;
            }
          }}
        , {field: 'order_pay_price', width: 150, align:"center" ,title: '实际支付金额',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.order_pay_price + '</span>';
            }else{
              return d.order_pay_price;
            }
          }}
        , {field: 'add_time', width: 180, align:"center" ,title: '创建时间',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.add_time + '</span>';
            }else{
              return d.add_time;
            }
          }}
        , {field: 'pay_time', width: 180, align:"center" ,title: '支付时间',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.pay_time + '</span>';
            }else{
              return d.pay_time;
            }
          }}
        // , {field: 'pay_username', width: 100, title: '付款人姓名'}
        , {
          field: 'status', width: 100, align:"center" ,title: '订单状态', templet: function (d) {
            var html = '';
            if (d.status == 0) {
              html = ' <button type="button"   class="layui-btn layui-btn-primary layui-btn-xs">未支付</button>';
            } else if (d.status == 1) {
              html = '<button type="button"  class="layui-btn layui-btn-xs">已支付</button>';
            } else if (d.status == 2) {
              html = '  <button type="button"   class="layui-btn layui-btn-warm layui-btn-xs">已关闭</button>';
            } else if (d.status == 3) {
              html = '<button type="button"   class="layui-btn layui-btn-disabled layui-btn-xs">已过期</button>'
            } else if (d.status == 5) {
              html = '<button type="button"   class="layui-btn layui-btn-warm layui-btn-xs">处理中</button>'
            } else {
              return '无';
            }
            return html;

          }
        }
        , {field: 'note',align:"center" ,width: 150, title: '订单备注',templet: function (d) {
            if (d.legality != 1){
              return '<span style="color: red">'+ d.note + '</span>';
            }else{
              return d.note;
            }
          }}

        , {width: 300, title: '操作',align:"center" , toolbar: "#table-order"}
      ]]
      , done: function (res, curr, count) {
        $(".layui-table-main tr").each(function (index, val) {
          $(".layui-table-fixed").each(function () {
            $($(this).find(".layui-table-body tbody tr")[index]).height($(val).height());
          });
        });
        $(".layui-table-header tr").each(function (index, val) {
          $(".layui-table-fixed").each(function () {
            $($(this).find(".layui-table-header thead tr")[index]).height($(val).height());
          });
        });
      }
    });


    table.on('tool(payOrderListFilter)', function (obj) {
      var data = obj.data;
      if (obj.event === 'issueOrder') {  // 监听添加操作
        if (getCookie('member_check_command_ok')){
          layer.confirm('确认收款？', {
            btn : [ '确定', '取消' ]//按钮
          }, function(index) {
            layer.close(index);
            $.ajax({
              url: "issueOrder",
              method: 'POST',
              data: {id: obj.data.id, pay_code: "{:input('pay_code')}"},
              success: function (res) {
                if (res.code == 1) {
                  table.reload('payOrderList');
                }
                layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
                layer.close(index); //关闭弹层
              }
            });
          });
        }else{
          {if condition="$is_pay_pass eq 1"}
          layer.prompt({
            formType: 1
            , title: '请输入请输入安全码'
          }, function (value, index) {
            layer.close(index);
            $.ajax({
              url: "issueOrder",
              method: 'POST',
              data: {pass: value, id: obj.data.id, pay_code: "{:input('pay_code')}"},
              success: function (res) {
                if (res.code == 1) {
                  table.reload('payOrderList');
                }
                layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
                layer.close(index); //关闭弹层
              }
            });
          });
          {else if condition="$is_pay_pass eq 2" }
          $.ajax({
            url: "issueOrder",
            method: 'POST',
            data: {id: obj.data.id, pay_code: "{:input('pay_code')}"},
            success: function (res) {
              if (res.code == 1) {
                table.reload('payOrderList');
              }
              layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
              layer.close(index); //关闭弹层
            }
          });
          {/if}
        }


        }else if (obj.event === 'issueOrders') {  // 监听添加操作
          {if condition="$is_pay_pass eq 1"}
          layer.prompt({
            formType: 1
            , title: '请输入请输入安全码'
          }, function (value, index) {
            layer.close(index);
            $.ajax({
              url: "issueOrders",
              method: 'POST',
              data: {pass: value, id: obj.data.id, pay_code: "{:input('pay_code')}"},
              success: function (res) {
                if (res.code == 1) {
                  table.reload('payOrderList');
                }
                layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
                layer.close(index); //关闭弹层
              }
            });
          });
          {else if condition="$is_pay_pass eq 2" }
          $.ajax({
            url: "issueOrders",
            method: 'POST',
            data: {id: obj.data.id, pay_code: "{:input('pay_code')}"},
            success: function (res) {
              if (res.code == 1) {
                table.reload('payOrderList');
              }
              layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
              layer.close(index); //关闭弹层
            }
          });
          {/if}
          }else if(obj.event === 'select-card'){

            layer.confirm(data.cardKey + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="layui-btn layui-btn-xs copy1" style="display:none;" data-clipboard-text="'+data.cardKey+'" ' +
                    '</a>', {
              title: '卡密信息',
              btn: ['确定'] //按钮

            });
          }else if(obj.event === 'is_legality'){
            //eg1
            layer.confirm('确定将此订单标为异常吗？', {
              btn: ['确定', '取消'] //可以无限个按钮
            }, function(index, layero){
              //按钮【按钮一】的回调
              $.ajax({
                url: "islegality",
                method: 'POST',
                data: {id: obj.data.id, pay_code: "{:input('pay_code')}"},
                success: function (res) {
                  if (res.code == 1) {
                    table.reload('payOrderList');
                  }
                  layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
                  layer.close(index); //关闭弹层
                }
              });
            }, function(index){
              //按钮【按钮二】的回调
            });

          }else if(obj.event === 'repeatEchaka'){
            //eg1
            layer.confirm('确定要提交至E查卡平台吗？', {
              btn: ['确定', '取消'] //可以无限个按钮
            }, function(index, layero){
              //按钮【按钮一】的回调
              $.ajax({
                url: "repeatEchaka",
                method: 'POST',
                data: {id: obj.data.id, pay_code: "{:input('pay_code')}"},
                success: function (res) {
                  if (res.code == 1) {
                    table.reload('payOrderList');
                  }
                  layer.msg(res.msg, {icon: res.code == 1 ? 1 : 2, time: 1500});
                  layer.close(index); //关闭弹层
                }
              });
            }, function(index){
              //按钮【按钮二】的回调
            });

          }else if(obj.event === 'uploadCardKey'){
            layer.prompt({
              formType: 0,
              title: "请输入卡密"
            }, function (d, f) {
              $.ajax({
                url: 'updateCardKey',
                method: 'POST',
                data: {order_id: obj.data.id, cardKey:d,pay_code: "{:input('pay_code')}"},
                success: function (res) {
                  if (res.code == 1) {
                    layer.closeAll();
                    table.reload('payOrderList');
                    layer.msg(res.msg, {icon: 1, time: 1500});
                  } else {
                    layer.msg(res.msg, {icon: 2, time: 1500});
                  }
                }
              });
            })

          }
        }


      );
        form.on('submit(order-search)', function (data) {
          table.reload('payOrderList', {
            page: {
              curr: 1
            }
            , where: data.field
          }, 'data');
          $.ajax({
            url:"/member/pay/searchStats?pay_code={:input('pay_code')}&code_id={:input('code_id')}",
            type : 'get',
            data:data.field,
            dataType:'json',
            success : function(data) {
              console.log(data);
              $("#amount").text(data.data.amount);
              $("#success_amount").text(data.data.success_amount);
              $("#count").text(data.data.count);
              $("#success_count").text(data.data.success_count);
              $("#success_rate").text(data.data.success_rate);
            }
          })
          return false;
        });
        form.on('switch(auto-refresh)', function (data) {
          $.ajax({
            url:"/member/Pay/yhk_order_refresh?pay_code=" + "{:input('pay_code')}",
            data:{status: data.elem.checked ? 1 : 0},
            method:'post',
            success:function(res){
              window.location.reload();
            }
          });
        });
        form.on('switch(editMsWorkStatus)',function (data) {
          $.ajax({
            url:"{:url('servers/edit_work_status')}",
            method:'post',
            data:{status:data.elem.checked ? 0 : 1},
            success:function(res){
              if(res.code == 1){
                layer.msg('操作成功',{icon:1,time:1500},function (){
                  window.location.reload();
                })
              }else{
                layer.msg('操作失败',{icon:2,time:1500}),function (){
                  window.location.reload();
                }
              }
            }
          })
        });
        table.on('toolbar(payOrderListFilter)', function (obj) {
          if (obj.event === 'refresh') {
            table.reload('payOrderList'); //数据刷新
          } else if (obj.event === 'export'){
            var locationUrl = "/member/pay/exportOrder?pay_code={:input('pay_code')}";
            var urlParams = layui.$('.layui-form').find('select,input[type=\'text\']').serialize();
            window.location.href = locationUrl + '&' + urlParams;
          }
        });
        lay('.app-laydate-item').each(function(k,v){
          var  timestamp=(k==0)?' 00:00:00':" 00:00:00";
          var date=new Date();
          date.setHours('00');date.setMinutes('00');date.setSeconds('00');
          if(k==1){
            date.setHours('23');date.setMinutes('59');date.setSeconds('59');
          }
          laydate.render({
            elem: this,
            format: 'yyyy-MM-dd',type:'datetime'
            ,istime:false
            ,value:date
            ,trigger: 'click'
          });
        });
      });
</script>